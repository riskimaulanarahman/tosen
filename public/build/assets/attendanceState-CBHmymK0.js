import{_ as I}from"./Modal-B9fOm8Jk.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as c,c as x,C as K,D as G,f as z,k as W,o as g,w as X,e,a as y,d as B,t as p,E as L}from"./app-CrbtziG4.js";const Y={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl"},$={class:"px-6 py-4 border-b border-gray-200 dark:border-gray-700"},J={class:"flex items-center justify-between"},Q={class:"text-lg font-medium text-gray-900 dark:text-white"},Z={class:"px-6 py-4"},ee={key:0,class:"text-center py-8"},ae={class:"text-red-600 dark:text-red-400 mb-4"},te={key:1,class:"space-y-4"},oe={class:"relative bg-black rounded-lg overflow-hidden",style:{"aspect-ratio":"16/9"}},re=["src"],ne={class:"flex justify-center space-x-4"},se={key:2,class:"space-y-4"},le={class:"relative bg-black rounded-lg overflow-hidden",style:{"aspect-ratio":"16/9"}},ie={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-black/60 text-white space-y-3"},ce={class:"flex justify-center"},ue=["disabled"],de={key:0,class:"absolute animate-spin w-8 h-8 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},me={class:"text-center"},ve={class:"text-sm text-gray-600 dark:text-gray-400"},he={key:0,class:"px-6 py-4 border-t border-gray-200 dark:border-gray-700"},ge={class:"flex justify-end"},fe={__name:"CameraModal",props:{show:{type:Boolean,default:!1},title:{type:String,default:"Ambil Foto Selfie"},cancelButtonTitle:{type:String,default:"Batal"},captureButtonTitle:{type:String,default:"Ambil Foto"},retakeButtonTitle:{type:String,default:"Ambil Ulang"},confirmButtonTitle:{type:String,default:"Gunakan Foto"}},emits:["close","capture","confirm"],setup(i,{emit:w}){const v=i,h=w,d=c(null),a=c(null),r=c(null),n=c(null),m=c(!1),s=c(""),l=c(!0),k=c(!1),T={video:{width:{ideal:1280},height:{ideal:720},facingMode:"user",aspectRatio:{ideal:16/9}},audio:!1},P=async(t=10)=>{for(let o=0;o<t;o++){if(await L(),a.value)return!0;await new Promise(b=>setTimeout(b,100))}return!1},_=async()=>{try{if(l.value=!0,s.value="",!await P()){s.value="Element video tidak ditemukan. Silakan refresh halaman.",l.value=!1;return}if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Kamera tidak didukung pada browser ini. Silakan gunakan browser modern.");console.log("Requesting camera permission with constraints:",T);try{d.value=await navigator.mediaDevices.getUserMedia(T)}catch(o){console.log("Primary constraints failed, trying fallback:",o);const b={video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:!1};d.value=await navigator.mediaDevices.getUserMedia(b)}console.log("Camera stream obtained:",d.value),a.value?(a.value.srcObject=d.value,a.value.onloadedmetadata=()=>{console.log("Video metadata loaded"),a.value.play().then(()=>{console.log("Video playing successfully"),m.value=!0,l.value=!1}).catch(o=>{console.error("Video play error:",o),s.value="Gagal memulai video. Silakan refresh halaman.",l.value=!1})},a.value.onerror=o=>{console.error("Video error:",o),s.value="Error saat memuat video. Silakan coba lagi.",l.value=!1}):(console.error("Video element not found"),s.value="Element video tidak ditemukan. Silakan refresh halaman.",l.value=!1)}catch(t){console.error("Camera initialization error:",t),s.value=D(t),l.value=!1,window.enhancedErrorHandler.handleError(t,D(t),{action:"camera_init",retryCallback:_})}},D=t=>{switch(t.name){case"NotAllowedError":case"PermissionDeniedError":return"Akses kamera ditolak. Silakan izinkan akses kamera di browser Anda dan refresh halaman.";case"NotFoundError":case"DevicesNotFoundError":return"Tidak ada kamera yang ditemukan. Pastikan kamera terhubung dan tidak digunakan oleh aplikasi lain.";case"NotSupportedError":return"Kamera tidak didukung. Silakan gunakan browser yang mendukung WebRTC (Chrome, Firefox, Safari, Edge).";case"NotReadableError":case"TrackStartError":return"Kamera sedang digunakan oleh aplikasi lain. Silakan tutup aplikasi lain yang menggunakan kamera dan coba lagi.";case"OverconstrainedError":case"ConstraintNotSatisfiedError":return"Kamera tidak memenuhi persyaratan. Mencoba dengan pengaturan default...";case"TypeError":return"Terjadi kesalahan saat mengakses kamera. Silakan refresh halaman dan coba lagi.";default:return t.message||"Terjadi kesalahan yang tidak diketahui saat mengakses kamera."}},M=()=>{if(!(!a.value||!r.value||!m.value))try{k.value=!0,r.value.width=a.value.videoWidth,r.value.height=a.value.videoHeight;const t=r.value.getContext("2d");t.drawImage(a.value,0,0,r.value.width,r.value.height);const b=new Date().toLocaleString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.fillStyle="white",t.strokeStyle="black",t.lineWidth=2,t.font="bold 16px Arial",t.textAlign="right",t.textBaseline="bottom",t.shadowColor="rgba(0, 0, 0, 0.8)",t.shadowBlur=4,t.shadowOffsetX=2,t.shadowOffsetY=2;const R=10,U=r.value.width-R,A=r.value.height-R;t.strokeText(b,U,A),t.fillText(b,U,A),r.value.toBlob(S=>{S&&(n.value=S,h("capture",S)),k.value=!1},"image/jpeg",.9)}catch(t){console.error("Capture photo error:",t),s.value="Gagal mengambil foto. Silakan coba lagi.",k.value=!1,window.enhancedErrorHandler.handleError(t,"Gagal mengambil foto. Silakan coba lagi.",{action:"camera_capture",retryCallback:M})}},F=async()=>{n.value=null,s.value="",E(),await L(),await _()},H=()=>{n.value&&(h("confirm",n.value),C())},C=()=>{h("close"),E()},E=()=>{d.value&&(d.value.getTracks().forEach(t=>{t.stop()}),d.value=null),a.value&&(a.value.srcObject=null),m.value=!1,l.value=!0,n.value=null,s.value="",k.value=!1},N=x(()=>n.value?URL.createObjectURL(n.value):null);K(()=>v.show,async t=>{t?await _():E()}),G(()=>{E()});const j=()=>{document.hidden?a.value&&a.value.pause():a.value&&m.value&&a.value.play()};return z(()=>{document.addEventListener("visibilitychange",j)}),G(()=>{document.removeEventListener("visibilitychange",j)}),(t,o)=>(g(),W(I,{show:i.show,onClose:C,"max-width":"2xl"},{default:X(()=>[e("div",Y,[e("div",$,[e("div",J,[e("h3",Q,p(i.title),1),e("button",{onClick:C,class:"text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"},[...o[0]||(o[0]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])]),e("div",Z,[s.value?(g(),y("div",ee,[o[1]||(o[1]=e("div",{class:"mb-4"},[e("svg",{class:"w-16 h-16 text-red-500 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})])],-1)),e("p",ae,p(s.value),1),e("button",{onClick:_,class:"px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500"}," Coba Lagi ")])):n.value?(g(),y("div",te,[e("div",oe,[e("img",{src:N.value,alt:"Captured selfie",class:"w-full h-full object-cover"},null,8,re)]),e("div",ne,[e("button",{onClick:F,class:"px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500"},p(i.retakeButtonTitle),1),e("button",{onClick:H,class:"px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"},p(i.confirmButtonTitle),1)])])):(g(),y("div",se,[e("div",le,[e("video",{ref_key:"video",ref:a,class:"w-full h-full object-cover",autoplay:"",playsinline:"",muted:""},null,512),l.value?(g(),y("div",ie,[...o[2]||(o[2]=[e("svg",{class:"animate-spin h-10 w-10 text-orange-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),e("span",{class:"text-sm font-medium"},"Mengaktifkan kamera...",-1)])])):B("",!0),o[3]||(o[3]=e("div",{class:"absolute inset-0 pointer-events-none"},[e("div",{class:"flex items-center justify-center h-full"},[e("div",{class:"relative"},[e("div",{class:"w-48 h-64 border-2 border-white border-opacity-50 rounded-full"}),e("div",{class:"absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white"}),e("div",{class:"absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white"}),e("div",{class:"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white"}),e("div",{class:"absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white"})])]),e("div",{class:"absolute bottom-4 left-0 right-0 text-center"},[e("p",{class:"text-white text-sm bg-black bg-opacity-50 inline-block px-4 py-2 rounded"}," Pastikan wajah Anda terlihat jelas dalam frame ")])],-1))]),e("div",ce,[e("button",{onClick:M,disabled:!m.value||k.value,class:"relative w-20 h-20 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 rounded-full flex items-center justify-center transition-colors focus:outline-none focus:ring-4 focus:ring-orange-300"},[o[5]||(o[5]=e("div",{class:"w-16 h-16 bg-white rounded-full"},null,-1)),k.value?(g(),y("svg",de,[...o[4]||(o[4]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])):B("",!0)],8,ue)]),e("div",me,[e("p",ve,p(l.value?"Mengaktifkan kamera...":m.value?"Klik tombol untuk mengambil foto":"Menunggu kamera siap..."),1)])]))]),!n.value&&!s.value?(g(),y("div",he,[e("div",ge,[e("button",{onClick:C,class:"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500"},p(i.cancelButtonTitle),1)])])):B("",!0)]),e("canvas",{ref_key:"canvas",ref:r,class:"hidden"},null,512)]),_:1},8,["show"]))}},Ce=q(fe,[["__scopeId","data-v-831f4209"]]),u=c(null),f=c(null),O=c(!1),V=c(""),ke=x(()=>!u.value||u.value.check_out_time),be=x(()=>u.value&&!u.value.check_out_time),ye=x(()=>u.value&&!u.value.check_out_time),pe=x(()=>{var n,m,s,l;if(!f.value||!u.value||u.value.check_out_time)return{requiresEarlyCheckoutRemarks:!1,requiresOvertimeRemarks:!1,workDurationMinutes:0,overtimeMinutes:0,earlyCheckoutThreshold:240,overtimeThreshold:60,earlyCheckoutRules:{min:10,max:300},overtimeRules:{min:10,max:500}};const i=u.value.check_in_time,v=i?Math.floor((new Date-new Date(i))/(1e3*60)):0,h=((m=(n=f.value)==null?void 0:n.operational_status)==null?void 0:m.status)==="closed"?0:((s=f.value)==null?void 0:s.current_overtime_minutes)||0,d=((l=f.value)==null?void 0:l.overtime_config)||{},a=d.early_checkout||{},r=d.overtime||{};return{requiresEarlyCheckoutRemarks:a.enabled&&a.mandatory_remarks&&v<a.threshold_minutes||!1,requiresOvertimeRemarks:r.mandatory_remarks&&h>=r.threshold_minutes||!1,workDurationMinutes:v,overtimeMinutes:h,earlyCheckoutThreshold:a.threshold_minutes||240,overtimeThreshold:r.threshold_minutes||60,earlyCheckoutRules:{min:a.remarks_min_length||10,max:a.remarks_max_length||300},overtimeRules:{min:r.remarks_min_length||10,max:r.remarks_max_length||500}}});function Ee(){const i=a=>{u.value=a},w=a=>{f.value=a},v=a=>{O.value=a};return{todayAttendance:u,outlet:f,isLoading:O,checkoutRemarks:V,canCheckIn:ke,canCheckOut:be,isCheckedIn:ye,checkoutValidation:pe,updateAttendance:i,updateOutlet:w,setLoading:v,resetCheckoutRemarks:()=>{V.value=""},fetchAttendanceStatus:async()=>{console.log("DEBUG: fetchAttendanceStatus called"),v(!0);try{const a=route("attendance.status");console.log("DEBUG: Fetching from URL:",a);const r=await fetch(a);if(console.log("DEBUG: Response received:",r),!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const n=await r.json();console.log("DEBUG: Data received:",n),i(n.today_attendance),w(n.outlet),console.log("DEBUG: State updated successfully"),console.log("DEBUG: Updated todayAttendance:",u.value),console.log("DEBUG: Updated outlet:",f.value)}catch(a){throw console.error("Error fetching attendance status:",a),console.error("DEBUG: Error details:",{message:a.message,stack:a.stack,name:a.name}),a}finally{console.log("DEBUG: Setting loading to false"),v(!1)}}}}export{Ce as C,Ee as u};
